"""Plan and Step models for task execution."""

from datetime import datetime
from enum import Enum
from typing import Any

from pydantic import BaseModel, ConfigDict, Field


class RiskLevel(str, Enum):
    """Risk level of a plan or step."""

    LOW = "LOW"
    MEDIUM = "MEDIUM"
    HIGH = "HIGH"


class Step(BaseModel):
    """A single step in an execution plan.

    Each step represents one tool invocation with its inputs and expected output.
    """

    id: str = Field(..., description="Unique identifier for this step (e.g., '1', '2', '3')")
    description: str = Field(..., description="Human-readable description of what this step does")
    tool: str = Field(..., description="Name of the tool to use (e.g., 'file', 'shell')")
    inputs: dict[str, Any] = Field(default_factory=dict, description="Input parameters for the tool")
    produces: str | None = Field(
        default=None,
        description="Description of what this step produces (e.g., 'file:out/summary.md')",
    )

    model_config = ConfigDict(
        json_schema_extra={
            "examples": [
                {
                    "id": "1",
                    "description": "Read the notes file",
                    "tool": "file",
                    "inputs": {"action": "read_text", "path": "data/notes.txt"},
                    "produces": "content:notes_content",
                }
            ]
        }
    )


class Plan(BaseModel):
    """An execution plan generated by the Planner.

    The plan contains a series of steps that will be executed sequentially
    to accomplish the user's goal.
    """

    goal: str = Field(..., description="The user's original goal/task description")
    risk_level: RiskLevel = Field(..., description="Overall risk level of this plan")
    workspace_root: str = Field(..., description="Root directory for file operations")
    steps: list[Step] = Field(..., description="Ordered list of steps to execute")
    success_criteria: list[str] = Field(
        ...,
        description="List of criteria that indicate successful completion",
    )
    created_at: str = Field(
        default_factory=lambda: datetime.now().isoformat(),
        description="Timestamp when this plan was created",
    )

    model_config = ConfigDict(
        json_schema_extra={
            "examples": [
                {
                    "goal": "Summarize data/notes.txt into 3 points and write to out/summary.md",
                    "risk_level": "LOW",
                    "workspace_root": "/Users/user/project",
                    "steps": [
                        {
                            "id": "1",
                            "description": "Read the notes file",
                            "tool": "file",
                            "inputs": {"action": "read_text", "path": "data/notes.txt"},
                            "produces": "content:notes_content",
                        },
                        {
                            "id": "2",
                            "description": "Summarize the content using LLM",
                            "tool": "llm",
                            "inputs": {
                                "prompt": "Summarize into 3 bullet points",
                                "content": "ref:step:1.output",
                            },
                            "produces": "content:summary",
                        },
                        {
                            "id": "3",
                            "description": "Write summary to output file",
                            "tool": "file",
                            "inputs": {
                                "action": "write_text",
                                "path": "out/summary.md",
                                "content": "ref:step:2.output",
                            },
                            "produces": "file:out/summary.md",
                        },
                    ],
                    "success_criteria": [
                        "File out/summary.md exists",
                        "File contains 3 bullet points",
                        "All steps completed successfully",
                    ],
                }
            ]
        }
    )

    def get_step_by_id(self, step_id: str) -> Step | None:
        """Get a step by its ID."""
        for step in self.steps:
            if step.id == step_id:
                return step
        return None

    def get_max_step_id(self) -> str:
        """Get the maximum step ID (assumes numeric IDs)."""
        if not self.steps:
            return "0"
        try:
            return str(max(int(step.id) for step in self.steps))
        except ValueError:
            # Non-numeric IDs, return the last one
            return self.steps[-1].id
